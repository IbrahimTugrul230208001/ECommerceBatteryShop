@{
    ViewBag.Title = "Sepetim";
}
<style>
    [x-cloak] {
        display: none !important
    }
</style>

<main class="bg-gray-50 dark:bg-gray-950 min-h-screen pt-28 pb-24">
    <div x-data="cartPage()" x-init="init()" class="mx-auto max-w-7xl px-4">

        <!-- Header -->
        <div class="mb-6 flex items-center justify-between">
            <h1 class="text-2xl font-semibold text-gray-900 dark:text-white">Sepetim</h1>
            <div class="flex items-center gap-4">
                <button @@click="clearCart" x-show="items.length" class="text-sm text-gray-600 hover:text-gray-900 dark:text-white/70 dark:hover:text-white">Sepeti boşalt</button>
                <a href="/" class="text-sm text-gray-600 hover:text-gray-900 dark:text-white/70 dark:hover:text-white">Alışverişe devam et</a>
            </div>
        </div>

        <!-- Empty state -->
        <div x-cloak x-show="items.length===0"
             class="rounded-2xl border border-gray-200 bg-white p-10 text-center text-gray-700 shadow-sm dark:border-white/10 dark:bg-gray-900/50 dark:text-white">
            <div class="mx-auto mb-3 h-12 w-12 grid place-items-center rounded-full bg-gray-100 dark:bg-white/10 text-gray-700 dark:text-white">
                <svg class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M6.3 5H21L19 12H7.38M20 16H8L6 3H3M9 20a1 1 0 1 1-2 0a1 1 0 0 1 2 0ZM20 20a1 1 0 1 1-2 0a1 1 0 0 1 2 0Z" /></svg>
            </div>
            <p class="text-lg">Sepetiniz boş.</p>
            <a href="/" class="mt-4 inline-flex h-11 items-center justify-center rounded-xl bg-amber-300 px-5 font-semibold text-gray-900 hover:bg-amber-400">Ürünlere Göz At</a>
        </div>

        <!-- Grid -->
        <div x-show="items.length>0" class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Items -->
            <section class="lg:col-span-2 rounded-2xl border border-gray-200 bg-white p-4 sm:p-6 shadow-sm dark:border-white/10 dark:bg-gray-900/50">
                <ul class="divide-y divide-gray-200 dark:divide-white/10">
                    <template x-for="item in items" :key="item.id">
                        <li class="py-4 sm:py-5 flex gap-4 sm:gap-6" x-transition>
                            <img src="/img/battery.jpg" :alt="item.name" class="h-20 w-20 sm:h-24 sm:w-24 rounded-lg object-cover bg-gray-100 dark:bg-white/10">
                            <div class="flex-1 min-w-0">
                                <div class="flex items-start justify-between gap-3">
                                    <div>
                                        <h3 class="text-gray-900 dark:text-white font-medium" x-text="item.name"></h3>
                                        <p class="text-gray-600 dark:text-white/60 text-sm" x-text="item.variant"></p>
                                    </div>
                                    <button @@click="remove(item.id)" class="text-gray-500 hover:text-gray-700 dark:text-white/60 dark:hover:text-white" aria-label="Kaldır" title="Kaldır">
                                        <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M3 6h18M8 6V4h8v2m-1 0v14a2 2 0 0 1-2 2h-2a2 2 0 0 1-2-2V6" /></svg>
                                    </button>
                                </div>

                                <div class="mt-3 flex flex-wrap items-center justify-between gap-3">
                                    <!-- Qty -->
                                    <label class="sr-only" :for="'qty-'+item.id">Adet</label>
                                    <div class="inline-flex h-9 items-center rounded-lg border border-gray-300 bg-white dark:border-white/10 dark:bg-white/5">
                                        <button @@click="dec(item)" class="px-3 h-full text-gray-700 hover:text-gray-900 dark:text-white/70 dark:hover:text-white" :aria-controls="'qty-'+item.id" aria-label="Azalt">−</button>
                                        <input :id="'qty-'+item.id" type="number" min="1" x-model.number="item.qty"
                                               class="w-16 bg-transparent text-center text-gray-900 dark:text-white outline-none"
                                               @@change="sanitize(item)" aria-live="polite" aria-label="Adet">
                                        <button @@click="inc(item)" class="px-3 h-full text-gray-700 hover:text-gray-900 dark:text-white/70 dark:hover:text-white" :aria-controls="'qty-'+item.id" aria-label="Arttır">+</button>
                                    </div>

                                    <!-- Unit price / line total -->
                                    <div class="ml-auto text-right">
                                        <div class="text-gray-500 dark:text-white/70 text-sm">Birim</div>
                                        <div class="text-gray-900 dark:text-white font-medium" x-text="formatCents(item.priceCents)"></div>
                                    </div>
                                    <div class="w-px h-8 bg-gray-200 dark:bg-white/10"></div>
                                    <div class="text-right">
                                        <div class="text-gray-500 dark:text-white/70 text-sm">Ara Toplam</div>
                                        <div class="text-gray-900 dark:text-white font-semibold" x-text="formatCents(item.priceCents * item.qty)"></div>
                                    </div>
                                </div>
                            </div>
                        </li>
                    </template>
                </ul>
            </section>

            <!-- Summary -->
            <aside class="rounded-2xl border border-gray-200 bg-white p-4 sm:p-6 h-max shadow-sm lg:sticky lg:top-24 dark:border-white/10 dark:bg-gray-900/50">
                <h2 class="text-gray-900 dark:text-white font-semibold mb-4">Sipariş Özeti</h2>

                <!-- Free shipping progress -->
                <template x-if="thresholdCents > 0">
                    <div class="mb-4">
                        <div class="flex items-center justify-between text-xs text-gray-600 dark:text-white/70">
                            <span x-text="subtotalCents < thresholdCents ? ('Ücretsiz kargo için ' + formatCents(thresholdCents - subtotalCents) + ' kaldı') : 'Ücretsiz kargo!' "></span>
                            <span x-text="Math.min(100, Math.round((subtotalCents/thresholdCents)*100)) + '%' "></span>
                        </div>
                        <div class="mt-2 h-2 w-full rounded-full bg-gray-100 dark:bg-white/10">
                            <div class="h-2 rounded-full bg-amber-300" :style="{width: Math.min(100, (subtotalCents/thresholdCents)*100) + '%'}"></div>
                        </div>
                    </div>
                </template>

                <dl class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <dt class="text-gray-600 dark:text-white/70">Ara toplam</dt>
                        <dd class="text-gray-900 dark:text-white" x-text="formatCents(subtotalCents)" aria-live="polite"></dd>
                    </div>
                    <div class="flex justify-between" x-show="activeCoupon">
                        <dt class="text-gray-600 dark:text-white/70">İndirim <button @@click="removeCoupon" class="ml-2 text-xs underline">(kaldır)</button></dt>
                        <dd class="text-gray-900 dark:text-white" x-text="discountCents>0 ? '-'+formatCents(discountCents) : formatCents(0)"></dd>
                    </div>
                    <div class="flex justify-between">
                        <dt class="text-gray-600 dark:text-white/70">Kargo</dt>
                        <dd class="text-gray-900 dark:text-white" x-text="shippingCents>0 ? formatCents(shippingCents) : 'Ücretsiz'"></dd>
                    </div>
                    <div class="flex justify-between">
                        <dt class="text-gray-600 dark:text-white/70">KDV (dahil)</dt>
                        <dd class="text-gray-900 dark:text-white" x-text="formatCents(vatIncludedCents)"></dd>
                    </div>
                    <div class="border-t border-gray-200 dark:border-white/10 pt-3 flex justify-between text-base">
                        <dt class="text-gray-900 dark:text-white">Toplam</dt>
                        <dd class="text-gray-900 dark:text-white font-semibold" x-text="formatCents(totalCents)" aria-live="polite"></dd>
                    </div>
                </dl>

                <button class="mt-4 w-full h-11 rounded-xl bg-amber-300 text-gray-900 font-semibold hover:bg-amber-400 transition" id="pay">
                    Güvenli Ödeme
                </button>
                <p class="mt-2 text-xs text-gray-500 dark:text-white/60 text-center">3D Secure desteklenir</p>
            </aside>
        </div>
    </div>

    <!-- Mobile sticky checkout -->
    <div x-show="items.length>0" x-cloak class="md:hidden fixed bottom-4 left-4 right-4 z-40">
        <div class="rounded-xl border border-gray-200 bg-white shadow-lg px-4 py-3 flex items-center justify-between dark:border-white/10 dark:bg-gray-900/80 backdrop-blur">
            <div>
                <div class="text-xs text-gray-600 dark:text-white/70">Toplam</div>
                <div class="font-semibold text-gray-900 dark:text-white" x-text="formatCents(totalCents)"></div>
            </div>
            <a href="#pay" class="inline-flex h-10 items-center rounded-lg bg-amber-300 px-4 font-semibold text-gray-900 hover:bg-amber-400">Ödeme</a>
        </div>
    </div>

    <!-- Toast -->
    <div x-cloak x-show="toast.show" x-transition.opacity.duration.200ms class="fixed bottom-6 left-1/2 -translate-x-1/2 z-50">
        <div class="rounded-lg px-4 py-2 text-sm shadow-lg"
             :class="{
            'bg-gray-900 text-white': toast.type==='info',
            'bg-green-600 text-white': toast.type==='success',
            'bg-amber-500 text-gray-900': toast.type==='warn',
            'bg-red-600 text-white': toast.type==='error'
          }">
            <div class="flex items-center gap-3">
                <span x-text="toast.text"></span>
                <button x-show="lastRemoved" @@click="undoRemove" class="underline">Geri Al</button>
            </div>
        </div>
    </div>
</main>

<script>
    function cartPage(){
      return {
        // config
        vatRate: 0.18,
        pricesIncludeVAT: true,

        // state
        items: [],
        coupon: '',
        activeCoupon: null,
        freeShipOverride: false,
        thresholdCents: 50000, // 500 TL – ücretsiz kargo eşiği
        shipFeeCents: 3990,    // 39,90 TL
        lastRemoved: null,
        toast: { show:false, text:'', type:'info', t:null },

        // lifecycle
        init(){
          const saved = localStorage.getItem('cart');
          if(saved){
            try { this.items = JSON.parse(saved) || []; } catch { this.items = []; }
          }
          if(this.items.length === 0){
            this.items = [
              { id: 1, name: 'Kalem Pil (AA)', variant: '2’li Paket', price: 39.90, qty: 2, image: '/img/demo/aa.jpg' },
              { id: 2, name: '9 Volt Pil',     variant: 'Tekli',      price: 54.50, qty: 1, image: '/img/demo/9v.jpg' }
            ];
          }
          this.normalizeItems();
          // auto persist on changes
          this.$watch('items', () => this.persist());
        },

        // computed (cents)
        get subtotalCents(){ return this.items.reduce((s,i)=> s + (i.priceCents * i.qty), 0); },
        get vatIncludedCents(){
          return this.pricesIncludeVAT
            ? Math.round(this.subtotalCents * (this.vatRate / (1 + this.vatRate)))
            : Math.round(this.subtotalCents * this.vatRate);
        },
        get shippingCents(){
          if(this.freeShipOverride) return 0;
          if(this.thresholdCents === 0) return this.subtotalCents > 0 ? this.shipFeeCents : 0;
          return (this.subtotalCents > 0 && this.subtotalCents < this.thresholdCents) ? this.shipFeeCents : 0;
        },
        get discountCents(){
          if(this.activeCoupon === 'INDIRIM10') return Math.round(this.subtotalCents * 0.10);
          if(this.activeCoupon === 'TRY50') return 5000; // 50 TL
          return 0;
        },
        get totalCents(){ return Math.max(0, this.subtotalCents + this.shippingCents - this.discountCents); },

        // helpers
        toCents(n){ return Math.round(Number(n) * 100); },
        formatCents(c){
          try { return (c/100).toLocaleString('tr-TR', { style: 'currency', currency: 'TRY', maximumFractionDigits: 2 }); }
          catch { return `${(c/100).toFixed(2)} TL`; }
        },
        persist(){ localStorage.setItem('cart', JSON.stringify(this.items)); },
        notify(text,type='info',timeout=2500){
          clearTimeout(this.toast.t); this.toast={ show:true, text, type, t:null };
          this.toast.t = setTimeout(()=> this.toast.show=false, timeout);
        },
        normalizeItems(){
          this.items = this.items.map(i => ({
            ...i,
            priceCents: i.priceCents ?? this.toCents(i.price ?? 0),
            qty: parseInt(i.qty || 1, 10)
          }));
        },

        // actions
        clearCart(){ this.items = []; this.persist(); this.notify('Sepet boşaltıldı','warn'); },
        remove(id){
          const idx = this.items.findIndex(i=>i.id===id);
          if(idx>-1){ this.lastRemoved = this.items[idx]; this.items.splice(idx,1); this.persist(); this.notify('Ürün kaldırıldı','warn'); }
        },
        undoRemove(){ if(this.lastRemoved){ this.items.push(this.lastRemoved); this.lastRemoved=null; this.persist(); this.notify('Geri alındı','success'); } },
        inc(i){ i.qty++; this.sanitize(i); },
        dec(i){ if(i.qty>1) { i.qty--; this.sanitize(i); } },
        sanitize(i){ i.qty = parseInt(i.qty || 1, 10); if(i.qty<1) i.qty = 1; },

        applyCoupon(){
          const code = (this.coupon || '').trim().toUpperCase();
          if(!code) return;
          if(code === 'INDIRIM10' || code === 'TRY50'){
            this.activeCoupon = code; this.notify(code + ' uygulandı','success');
          } else if(code === 'KARGO'){
            this.freeShipOverride = true; this.notify('KARGO uygulandı: Ücretsiz kargo','success');
          } else {
            this.notify('Geçersiz ya da zaten uygulanmış kupon','error');
          }
          this.coupon = '';
        },
        removeCoupon(){ this.activeCoupon=null; this.notify('Kupon kaldırıldı','info'); },
      }
    }
</script>
