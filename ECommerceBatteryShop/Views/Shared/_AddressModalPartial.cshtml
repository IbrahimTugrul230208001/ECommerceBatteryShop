<!-- Address Modal -->
<style>
    [x-cloak] {
        display: none !important;
    }
</style>
<div x-data x-cloak>
    <div x-show="$store.address.open" x-transition.opacity
         class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/40"
         role="dialog" aria-modal="true"
         @@keydown.window.escape="$store.address.close()">
        <div class="w-full max-w-lg rounded-md bg-white shadow-xl ring-1 ring-black/10"
             @@click.outside="$store.address.close()">
            <div class="flex items-center justify-between p-4 border-b border-slate-300">
                <h3 class="text-base font-semibold text-slate-600" x-text="$store.address.form.id ? 'Adres Düzenle' : 'Adres Ekle'"></h3>
                <button class="p-2 rounded text-slate-500 hover:bg-slate-100" @@click="$store.address.close()">✕</button>
            </div>
            <form class="p-4 space-y-4"
                  hx-post="@Url.Action("Upsert", "Addres")"
                  hx-target="#address-list"
                  hx-swap="outerHTML"
                  data-address-form
                  x-on:htmx:afterOnLoad.window="$store.address.close(); $store.address.reset()">
                @Html.AntiForgeryToken()
                <input type="hidden" name="Id" x-model="$store.address.form.id" />

                <div>
                    <label class="block text-sm font-medium text-slate-700">Adres Başlığı *</label>
                    <input name="Title" required x-model="$store.address.form.title"
                           class="mt-1 p-2 w-full rounded-lg border border-slate-300 focus:ring-amber-300 focus:border-amber-300" />
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700">Ad *</label>
                        <input name="Name" required x-model="$store.address.form.name"
                               class="mt-1 p-2 w-full rounded-lg border border-slate-300 focus:ring-amber-300 focus:border-amber-300" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700">Soyad *</label>
                        <input name="Surname" required x-model="$store.address.form.surname"
                               class="mt-1 p-2 w-full rounded-lg border border-slate-300 focus:ring-amber-300 focus:border-amber-300" />
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700">Telefon *</label>
                        <input name="PhoneNumber" required placeholder="+90 5XX XXX XX XX" x-model="$store.address.form.phoneNumber"
                               class="mt-1 p-2 w-full rounded-lg border border-slate-300 focus:ring-amber-300 focus:border-amber-300" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700">İl *</label>
                        <input name="City" required x-model="$store.address.form.city"
                               class="mt-1 p-2 w-full rounded-lg border border-slate-300 focus:ring-amber-300 focus:border-amber-300" />
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-700">Adres *</label>
                    <textarea name="FullAddress" rows="3" required x-model="$store.address.form.fullAddress"
                              placeholder="Adresinizi mahalle, sokak, cadde, bina ve daire numarası ile beraber tam girdiğinizden emin olun."
                              class="mt-1 w-full rounded-lg p-2 border border-slate-300 focus:ring-amber-300 focus:border-amber-300"></textarea>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700">İlçe *</label>
                        <input name="State" required x-model="$store.address.form.state"
                               class="mt-1 p-2 w-full rounded-lg border border-slate-300 focus:ring-amber-300 focus:border-amber-300" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700">Mahalle *</label>
                        <input name="Neighbourhood" required x-model="$store.address.form.neighbourhood"
                               class="mt-1 p-2 w-full rounded-lg border border-slate-300 focus:ring-amber-300 focus:border-amber-300" />
                    </div>
                </div>

                <div class="flex items-center gap-2">
                    <input type="checkbox"
                           name="IsDefault"
                           value="true"
                           x-model="$store.address.form.isDefault"
                           class="rounded border-slate-300 text-amber-500 focus:ring-amber-300" />
                    <span class="text-sm text-slate-600">Varsayılan adres yap</span>
                </div>

                <div class="flex items-center justify-end gap-2 pt-2">
                    <button type="button"
                            @@click="$store.address.close(); $store.address.reset()"
                            class="rounded-lg border border-slate-400 px-4 py-2 text-sm text-slate-600 hover:bg-slate-100">
                        Vazgeç
                    </button>
                    <button type="submit"
                            class="rounded-lg bg-amber-300 px-4 py-2 text-sm font-semibold border border-amber-300 text-gray-900 hover:bg-amber-400">
                        Kaydet
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('alpine:init', () => {
      Alpine.store('address', {
        open: false,
        form: defaultForm(),
        openNew() {
          this.reset();
          this.open = true;
        },
        edit(payload) {
          this.form = { ...defaultForm(), ...(payload || {}) };
          this.form.id = payload?.id ?? null;
          this.form.isDefault = Boolean(payload?.isDefault);
          this.open = true;
        },
        close() {
          this.open = false;
        },
        reset() {
          this.form = defaultForm();
        }
      });

      if (!window.__addressModalHxListener) {
        window.__addressModalHxListener = true;

        document.body.addEventListener('htmx:afterSwap', (event) => {
          const target = event.detail?.target;
          if (!target || target.id !== 'address-list') {
            return;
          }

          if (window.Alpine && typeof window.Alpine.initTree === 'function') {
            window.Alpine.initTree(target);
          }

          const source = event.detail?.requestConfig?.elt;
          const shouldReset = Boolean(source?.hasAttribute('data-address-form')) && event.detail?.successful;

          if (shouldReset && window.Alpine?.store('address')) {
            window.Alpine.store('address').close();
            window.Alpine.store('address').reset();
          }
        });
      }

      function defaultForm() {
        return {
          id: null,
          title: '',
          name: '',
          surname: '',
          phoneNumber: '',
          city: '',
          state: '',
          neighbourhood: '',
          fullAddress: '',
          isDefault: false
        };
      }
    });
</script>
