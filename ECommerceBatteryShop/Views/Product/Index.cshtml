@using System.Globalization
@model IEnumerable<ECommerceBatteryShop.Models.ProductViewModel>

@{
    var products = Model ?? Array.Empty<ECommerceBatteryShop.Models.ProductViewModel>();

    var hasResults = products.Any();
    var minQ = Context.Request.Query["minPrice"].ToString();
    var maxQ = Context.Request.Query["maxPrice"].ToString();
    var hasFilter = !string.IsNullOrWhiteSpace(minQ) || !string.IsNullOrWhiteSpace(maxQ);
}

<!-- Include once globally (Layout). Safe if duplicated -->
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>




@if (!hasResults)
{
    <!-- EMPTY STATE -->
    <div class="mx-auto max-w-screen-md">
        <div class="mt-10 rounded-2xl border border-slate-200 bg-white p-10 text-center shadow-sm">
            <div class="mx-auto mb-4 grid h-16 w-16 place-items-center rounded-full ring-1 ring-slate-200">
                <svg class="h-8 w-8 text-slate-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
                    <rect x="3" y="7" width="18" height="10" rx="2"></rect>
                    <rect x="21" y="10" width="1.5" height="4" rx="0.5" fill="currentColor" stroke="none"></rect>
                    <path d="M7 10h6M7 13h4" />
                </svg>
            </div>

            <h2 class="text-xl font-semibold">Sonuç bulunamadı</h2>
            <p class="mt-1 text-sm text-slate-600">
                Aramanız için eşleşen ürün yok. Yazımı kontrol edin ya da filtreleri gevşetin.
            </p>

            <div class="mt-6 flex flex-wrap items-center justify-center gap-3">
                @if (hasFilter)
                {
                    <a href="@Url.Action("Index", "Product")"
                       class="inline-flex items-center gap-2 rounded-lg border border-slate-300 bg-white px-4 py-2 text-sm font-medium hover:bg-slate-50">
                        Filtreleri temizle
                    </a>
                }
                <a href="@Url.Action("Index", "Product")"
                   class="inline-flex items-center gap-2 rounded-lg bg-amber-300 px-4 py-2 text-sm font-semibold text-gray-900 shadow hover:bg-amber-400">
                    Tüm ürünlere dön
                </a>
            </div>

            <div class="mt-8 grid grid-cols-1 gap-3 sm:grid-cols-3">
                <div class="rounded-xl border border-slate-200 p-3 text-left">
                    <div class="text-xs font-semibold text-slate-500">İpucu</div>
                    <div class="mt-1 text-sm">Fiyat aralığını genişletin (örn. min ↓, max ↑).</div>
                </div>
                <div class="rounded-xl border border-slate-200 p-3 text-left">
                    <div class="text-xs font-semibold text-slate-500">İpucu</div>
                    <div class="mt-1 text-sm">Daha kısa veya genel bir anahtar kelime deneyin.</div>
                </div>
                <div class="rounded-xl border border-slate-200 p-3 text-left">
                    <div class="text-xs font-semibold text-slate-500">İpucu</div>
                    <div class="mt-1 text-sm">Türkçe/İngilizce varyasyonları deneyin (18650, 21700 vs.).</div>
                </div>
            </div>
        </div>
    </div>
}
else
{
    <h1 class="text-2xl font-bold mb-4">Ürünler</h1>

    <div class="mx-auto max-w-screen-lg px-4 sm:px-2 md:px-4">
        <form method="get" class="mb-6 flex flex-wrap items-center gap-x-3 gap-y-3">
            <input type="number" step="0.01" name="minPrice" placeholder="Min Fiyat"
                   value="@minQ"
                   class="w-full sm:w-auto flex-1 min-w-[140px] sm:min-w-[200px]
                          border border-gray-200 focus:border-gray-400 focus:ring-0
                          rounded-lg px-3 py-2 text-base" />
            <input type="number" step="0.01" name="maxPrice" placeholder="Max Fiyat"
                   value="@maxQ"
                   class="w-full sm:w-auto flex-1 min-w-[140px] sm:min-w-[200px]
                          border border-gray-200 focus:border-gray-400 focus:ring-0
                          rounded-lg px-3 py-2 text-base" />
            <button type="submit"
                    class="flex items-center gap-2 px-4 py-2 rounded-xl bg-amber-300 text-gray-900 font-semibold shadow hover:bg-amber-400 transition">
                Filtrele
                <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none"><path d="M3 4.6C3 4.03995 3 3.75992 3.10899 3.54601C3.20487 3.35785 3.35785 3.20487 3.54601 3.10899C3.75992 3 4.03995 3 4.6 3H19.4C19.9601 3 20.2401 3 20.454 3.10899C20.6422 3.20487 20.7951 3.35785 20.891 3.54601C21 3.75992 21 4.03995 21 4.6V6.33726C21 6.58185 21 6.70414 20.9724 6.81923C20.9479 6.92127 20.9075 7.01881 20.8526 7.10828C20.7908 7.2092 20.7043 7.29568 20.5314 7.46863L14.4686 13.5314C14.2957 13.7043 14.2092 13.7908 14.1474 13.8917C14.0925 13.9812 14.0521 14.0787 14.0276 14.1808C14 14.2959 14 14.4182 14 14.6627V17L10 21V14.6627C10 14.4182 10 14.2959 9.97237 14.1808C9.94787 14.0787 9.90747 13.9812 9.85264 13.8917C9.7908 13.7908 9.70432 13.7043 9.53137 13.5314L3.46863 7.46863C3.29568 7.29568 3.2092 7.2092 3.14736 7.10828C3.09253 7.01881 3.05213 6.92127 3.02763 6.81923C3 6.70414 3 6.58185 3 6.33726V4.6Z" stroke="#000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>
            </button>

            @if (hasFilter)
            {
                <a href="@Url.Action("Index", "Product")"
                   class="ml-auto inline-flex items-center gap-2 rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm hover:bg-slate-50">
                    Filtreleri temizle
                </a>
            }
        </form>
    </div>
    <!-- PRODUCT GRID -->
    <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-6">
        @foreach (var product in products)
        {
            var href = Url.Action("Details", "Product", new { id = product.Id });
            var price = product.Price.ToString("C", new CultureInfo("tr-TR"));
            var fullStars = (int)Math.Floor(product.Rating);
            var hasHalf = product.Rating - fullStars >= 0.5;

            <div class="group relative rounded-2xl border border-slate-200 bg-white shadow-md ring-1 ring-gray-100 hover:shadow-xl transition overflow-hidden">
                <a href="@href" class="block p-4">
                    <div class="rounded-xl h-40 flex items-center justify-center overflow-hidden">
                        <img src="/img/@(string.IsNullOrWhiteSpace(product.ImageUrl) ? "temsili.png" : product.ImageUrl)"
                             alt="@(string.IsNullOrWhiteSpace(product.Name) ? "Görsel yok" : product.Name)"
                             class="h-28 w-auto object-contain transition-transform duration-200 group-hover:scale-[1.03]" />
                    </div>

                    <div class="mt-4 space-y-2">
                        <h3 class="font-semibold leading-snug line-clamp-2">@product.Name</h3>
                        <div class="flex items-baseline gap-2">
                            <span class="text-lg font-bold">@price</span>
                        </div>
                        @* Rating istersen aç *@
                        @*
                        <div class="flex items-center gap-1 text-yellow-500">
                            @for (int i = 0; i < fullStars && i < 5; i++)
                            {
                                @:<svg class="w-4 h-4 fill-current" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.967 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.176 0l-2.8 2.034c-.784.57-1.839-.197-1.54-1.118l-1.07-3.292a1 1 0 00-.364-1.118L2.88 8.72c-.783-.57-.379-1.81.588-1.81H6.93a1 1 0 00.95-.69l1.17-3.292z" /></svg>
                            }
                            @if (hasHalf && fullStars < 5)
                            {
                                @:<svg class="w-4 h-4 text-yellow-500" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.967 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.176 0l-2.8 2.034c-.784.57-1.839-.197-1.54-1.118l-1.07-3.292a1 1 0 00-.364-1.118L2.88 8.72c-.783-.57-.379-1.81.588-1.81H6.93a1 1 0 00.95-.69l1.17-3.292z" /></svg>
                            }
                            <span class="ml-1 text-sm text-gray-500">(@product.Rating.ToString("0.0"))</span>
                        </div>
                        *@
                    </div>
                </a>

                <div class="mt-3 mb-3 flex items-center gap-2 px-3">
                    <button hx-post="/Cart/Add"
                            hx-vals='{"productId": @product.Id, "quantity": 1}'
                            hx-swap="none"
                            x-data="{ added: false }"
                            @@click="if (added) return; added = true; setTimeout(() => added = false, 1600);"
                            :class="added ? 'bg-green-500 text-white' : 'bg-amber-300 text-gray-900 hover:bg-amber-400'"
                            class="flex-1 h-9 rounded-md text-sm font-semibold shadow transition-colors duration-300 relative overflow-hidden focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-yellow-400 cursor-pointer">
                        <span x-show="!added"
                              x-transition:enter="transition transform ease-out duration-250"
                              x-transition:enter-start="-translate-y-3 opacity-0"
                              x-transition:enter-end="translate-y-0 opacity-100"
                              x-transition:leave="transition transform ease-in duration-200"
                              x-transition:leave-start="translate-y-0 opacity-100"
                              x-transition:leave-end="translate-y-3 opacity-0"
                              class="block">
                            Sepete ekle
                        </span>

                        <span x-show="added"
                              x-transition:enter="transition transform ease-out duration-250"
                              x-transition:enter-start="translate-y-3 opacity-0"
                              x-transition:enter-end="translate-y-0 opacity-100"
                              x-transition:leave="transition transform ease-in duration-200"
                              x-transition:leave-start="translate-y-0 opacity-100"
                              x-transition:leave-end="-translate-y-3 opacity-0"
                              class="absolute inset-0 flex items-center justify-center gap-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 align-middle" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path d="M20 6L9 17l-5-5" />
                            </svg>
                            <span class="align-middle text-white">Sepete eklendi</span>
                        </span>
                    </button>

                    <button type="button"
                            x-data="{ fav: @(product.IsFavorite ? "true" : "false"), busy: false }"
                            @@click="if (busy) return; busy=true; fav=!fav; setTimeout(()=> busy=false, 300);"
                            hx-post="/Favorites/Toggle"
                            :hx-vals="JSON.stringify({ productId: @product.Id})"
                            hx-swap="none"
                            :aria-pressed="fav.toString()"
                            :class="fav ? 'text-rose-600 border-rose-300 bg-rose-50' : 'text-gray-700 border-gray-300 hover:bg-gray-100'"
                            class="relative h-9 w-9 grid place-items-center rounded-md border cursor-pointer transition-colors duration-200 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-rose-400">
                        <span class="sr-only" x-text="fav ? 'Favorilerden çıkar' : 'Favorilere ekle'"></span>

                        <div class="relative h-5 w-5">
                            <svg xmlns="http://www.w3.org/2000/svg"
                                 class="absolute inset-0 h-5 w-5 transition-all duration-200 ease-out"
                                 :class="fav ? 'opacity-0 scale-90' : 'opacity-100 scale-100'"
                                 viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                 stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78L12 21.23l8.84-8.84a5.5 5.5 0 0 0 0-7.78z" />
                            </svg>
                            <svg xmlns="http://www.w3.org/2000/svg"
                                 class="absolute inset-0 h-5 w-5 transition-all duration-220 ease-out"
                                 :class="fav ? 'opacity-100 scale-100' : 'opacity-0 scale-110'"
                                 viewBox="0 0 24 24" fill="currentColor">
                                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78L12 21.23l8.84-8.84a5.5 5.5 0 0 0 0-7.78z" />
                            </svg>
                        </div>
                    </button>
                </div>
            </div>
        }
    </div>
}

<style>
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    input[type=number] {
        -moz-appearance: textfield;
    }
</style>
